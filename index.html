<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ—…ã®ã—ãŠã‚Š (æ—…éŠæ‰‹å¸³)</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Leaflet CSS & JS (åœ°åœ–åŠŸèƒ½) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #FDFBF7;
            --primary: #6A8372;
            --primary-light: #E6EBE7;
            --accent: #DFA89B;
            --text-main: #464646;
            --text-light: #8A8A8A;
            --card-bg: #FFFFFF;
            --border: #E8E6E1;
            --shadow: 0 4px 20px rgba(106, 131, 114, 0.08);
            --radius: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow-x: hidden; }
        body { 
            font-family: 'Zen Maru Gothic', -apple-system, sans-serif; 
            background: var(--bg-color); 
            color: var(--text-main);
            letter-spacing: 0.03em;
        }

        .app { max-width: 500px; margin: 0 auto; min-height: 100vh; position: relative; background: var(--bg-color); }
        
        .header {
            background-color: var(--bg-color);
            padding: 30px 24px 20px;
            text-align: center;
        }
        
        .trip-badge {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-bottom: 12px;
            letter-spacing: 1px;
        }

        .header h1 { font-size: 28px; margin-bottom: 8px; font-weight: 700; color: var(--text-main); }
        .header p { font-size: 14px; color: var(--text-light); font-weight: 500; }
        
        .weather-info {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 12px 20px;
            display: inline-flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        .weather-temp { font-size: 24px; font-weight: 700; color: var(--primary); }
        .weather-desc { font-size: 13px; color: var(--text-light); }

        .tabs { 
            display: flex; justify-content: center; padding: 0 5px; margin-bottom: 20px;
            background: rgba(253, 251, 247, 0.95);
            position: sticky; top: 0; z-index: 99;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .tab { 
            flex: 1; padding: 16px 2px; border: none; background: none; 
            font-size: 14px; cursor: pointer; color: #999; 
            transition: all 0.3s; font-weight: 500; position: relative; white-space: nowrap;
        }
        .tab.active { color: var(--primary); font-weight: 700; }
        .tab.active::after {
            content: ''; position: absolute; bottom: 6px; left: 50%;
            transform: translateX(-50%); width: 6px; height: 6px;
            background: var(--accent); border-radius: 50%;
        }
        
        .content { padding: 0 20px 120px 20px; }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        
        /* ç™»æ©Ÿè­‰æ¨£å¼ */
        .flight-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow);
        }
        .flight-header {
            background: var(--primary);
            color: white;
            padding: 10px 15px;
            font-size: 13px;
            font-weight: 700;
            display: flex; justify-content: space-between;
        }
        .flight-body { padding: 15px; }
        .flight-route { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .flight-code { font-size: 24px; font-weight: 700; color: var(--text-main); }
        .flight-label { font-size: 11px; color: #999; margin-bottom: 2px; }
        .flight-val { font-size: 14px; font-weight: 500; }
        .flight-plane { color: var(--accent); font-size: 20px; transform: rotate(90deg); }

        .day-slider { display: flex; overflow-x: auto; gap: 12px; margin-bottom: 24px; padding: 4px; -webkit-overflow-scrolling: touch; }
        .day-slider::-webkit-scrollbar { display: none; }
        .day-btn { 
            min-width: 64px; height: 80px; border-radius: 30px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            background: white; border: 1px solid var(--border); color: var(--text-light);
            cursor: pointer; flex-shrink: 0; transition: all 0.3s; 
        }
        .day-btn.active { 
            background: var(--primary); color: white; border-color: var(--primary); 
            transform: translateY(-4px); box-shadow: 0 8px 16px rgba(106, 131, 114, 0.25);
        }
        
        .item-card {
            background: white; border-radius: var(--radius); padding: 0;
            margin-bottom: 16px; border: 1px solid var(--border); box-shadow: var(--shadow);
            overflow: hidden; display: flex; transition: transform 0.2s;
        }
        .item-card:active { transform: scale(0.99); }
        
        .item-time-col {
            padding: 18px 12px; background: var(--primary-light);
            display: flex; flex-direction: column; align-items: center;
            min-width: 70px; border-right: 1px dashed var(--border);
        }
        .item-time { font-size: 14px; font-weight: 700; color: var(--primary); }
        
        .item-main { padding: 16px; flex: 1; }
        .item-title { font-size: 16px; font-weight: 700; color: var(--text-main); margin-bottom: 4px; }
        .item-loc { font-size: 12px; color: var(--text-light); display: flex; align-items: center; gap: 4px; cursor: pointer; }
        .item-loc:hover { color: var(--primary); }
        
        .tag { font-size: 11px; padding: 2px 8px; border-radius: 4px; margin-top: 8px; display: inline-block; }
        .tag.æ™¯é» { background: #E3F2FD; color: #5C88AA; }
        .tag.ç¾é£Ÿ { background: #FCE4EC; color: #AA5C76; }
        .tag.è³¼ç‰© { background: #FFF8E1; color: #AA8D5C; }
        .tag.äº¤é€š { background: #F1F8E9; color: #6D8E58; }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 30px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s; font-family: inherit; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(106, 131, 114, 0.3); }
        .btn-add-small { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 13px; }
        .btn-link { font-size: 12px; color: var(--primary); background: #eee; padding: 4px 10px; border-radius: 12px; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; margin-top: 6px; margin-right: 6px; }

        .translate-btn {
            background: white; border: 1px solid var(--border); border-radius: 20px; padding: 20px;
            display: flex; align-items: center; justify-content: space-between; text-decoration: none;
            color: var(--text-main); box-shadow: var(--shadow); margin-bottom: 12px;
        }
        .translate-btn strong { display: block; font-size: 18px; margin-bottom: 4px; color: var(--primary); }
        .translate-btn span { font-size: 13px; color: #999; }
        .translate-icon { font-size: 32px; opacity: 0.8; }
        
        .app-btn { background: linear-gradient(135deg, #4285F4, #34A853); color: white; border: none; }
        .app-btn strong { color: white; }
        .app-btn span { color: rgba(255,255,255,0.8); }

        .data-btn { background: white; border: 1px solid var(--border); padding: 12px; border-radius: 12px; color: var(--text-light); font-size: 14px; cursor: pointer; text-align: center; flex: 1; }
        .member-tag { background: #eee; padding: 4px 12px; border-radius: 20px; font-size: 13px; display: flex; align-items: center; gap: 6px; }

        #embedded-map { width: 100%; height: 100%; border-radius: var(--radius); z-index: 1; }
        .map-container { height: 60vh; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); border: 4px solid white; position: relative; }
        .map-loading { position: absolute; inset: 0; background: #f0f0f0; display: flex; align-items: center; justify-content: center; z-index: 2; color: #999; font-size: 14px; }

        .input { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 12px; margin-top: 6px; font-size: 15px; background: #fdfdfd; font-family: inherit; }
        .input:focus { outline: none; border-color: var(--primary); background: white; }
        .modal { background: rgba(70, 70, 70, 0.4); backdrop-filter: blur(2px); }
        .modal-content { border-radius: 24px 24px 0 0; background: #FDFBF7; }
        
        .flex { display: flex; gap: 10px; }
        .flex-1 { flex: 1; }
        .text-center { text-align: center; }
        .mb-15 { margin-bottom: 15px; }
        .icon-btn { width: 32px; height: 32px; border: none; background: transparent; color: #aaa; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .settle-arrow { color: var(--accent); font-weight: bold; margin: 0 8px; }
    </style>
</head>
<body>
    <div id="app" class="app">
        <!-- Header -->
        <div class="header">
            <div class="trip-badge" v-if="tripTitle">{{ tripTitle }}</div>
            <div v-if="!editingHeader" v-on:click="startEditHeader" style="cursor: pointer;">
                <h1>{{ tripTitle || 'æ±äº¬ä¹‹æ—…' }}</h1>
                <p>ğŸ“… {{ tripDates || 'é»æ“Šè¨­å®šæ—¥æœŸ' }}</p>
                <div v-if="weather.loaded" class="weather-info">
                    <div v-html="weather.icon" style="color: var(--accent);"></div>
                    <div style="text-align: left;">
                        <div class="weather-temp">{{ weather.temp }}Â°C</div>
                        <div class="weather-desc">{{ weather.description }}</div>
                    </div>
                </div>
            </div>

            <!-- Header ç·¨è¼¯æ¨¡å¼ -->
            <div v-if="editingHeader" style="background: white; padding: 20px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-top: 10px; position: relative; z-index: 100;">
                <select v-model="tripTitle" class="input" style="margin-bottom: 10px;" @change="autoSetCurrency">
                    <option value="">é¸æ“‡åŸå¸‚</option>
                    <option value="æ±äº¬">ğŸ‡¯ğŸ‡µ æ±äº¬ (JPY)</option>
                    <option value="å¤§é˜ª">ğŸ‡¯ğŸ‡µ å¤§é˜ª (JPY)</option>
                    <option value="äº¬éƒ½">ğŸ‡¯ğŸ‡µ äº¬éƒ½ (JPY)</option>
                    <option value="é¦–çˆ¾">ğŸ‡°ğŸ‡· é¦–çˆ¾ (KRW)</option>
                    <option value="æ›¼è°·">ğŸ‡¹ğŸ‡­ æ›¼è°· (THB)</option>
                    <option value="å°åŒ—">ğŸ‡¹ğŸ‡¼ å°åŒ— (TWD)</option>
                    <option value="å€«æ•¦">ğŸ‡¬ğŸ‡§ å€«æ•¦ (EUR)</option>
                    <option value="å·´é»">ğŸ‡«ğŸ‡· å·´é» (EUR)</option>
                    <option value="ç´ç´„">ğŸ‡ºğŸ‡¸ ç´ç´„ (USD)</option>
                </select>
                <div class="flex">
                    <div class="flex-1">
                        <div style="font-size: 12px; color: #999; margin-bottom: 4px;">é–‹å§‹</div>
                        <input v-model="startDate" type="date" class="input">
                    </div>
                    <div class="flex-1">
                        <div style="font-size: 12px; color: #999; margin-bottom: 4px;">çµæŸ</div>
                        <input v-model="endDate" type="date" class="input">
                    </div>
                </div>
                <div class="flex" style="margin-top: 15px;">
                    <button v-on:click="cancelHeaderEdit" class="btn" style="background: #eee; color: #666;">å–æ¶ˆ</button>
                    <button v-on:click="saveHeaderEdit" class="btn btn-primary">ç¢ºå®š</button>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab" :class="{active: tab==='plan'}" @click="tab='plan'">è¡Œç¨‹</button>
            <button class="tab" :class="{active: tab==='map'}" @click="switchTab('map')">åœ°åœ–</button>
            <button class="tab" :class="{active: tab==='money'}" @click="tab='money'">åˆ†å¸³</button>
            <button class="tab" :class="{active: tab==='todo'}" @click="tab='todo'">æ¸…å–®</button>
            <button class="tab" :class="{active: tab==='translate'}" @click="tab='translate'">ç¿»è­¯</button>
        </div>

        <!-- å…§å®¹å€ -->
        <div class="content">
            <!-- 1. è¡Œç¨‹ Tab -->
            <div v-if="tab==='plan'">
                
                <!-- èˆªç­æŒ‰éˆ•/å¡ç‰‡å€ -->
                <div style="margin-bottom: 20px;">
                    <button v-if="!showFlightCard" @click="showFlightCard=true" class="btn" style="background: white; border: 1px dashed var(--primary); color: var(--primary); padding: 10px;">
                        + è¨­å®šèˆªç­è³‡è¨Š
                    </button>
                    
                    <div v-if="showFlightCard" class="flight-card">
                        <div class="flight-header">
                            <span>âœˆï¸ FLIGHT TICKET</span>
                            <span @click="showFlightEdit=true" style="cursor: pointer;">âœï¸ ç·¨è¼¯</span>
                        </div>
                        <div class="flight-body">
                            <!-- å»ç¨‹ -->
                            <div class="flight-route">
                                <div>
                                    <div class="flight-code">{{ flights.in.from || 'TPE' }}</div>
                                    <div class="flight-val">{{ flights.in.time || '00:00' }}</div>
                                </div>
                                <div class="text-center">
                                    <div class="flight-label">{{ flights.in.date || 'Date' }}</div>
                                    <div class="flight-plane">âœˆ</div>
                                    <div class="flight-label">{{ flights.in.no || 'Flight No.' }}</div>
                                </div>
                                <div class="text-center">
                                    <div class="flight-code">{{ flights.in.to || 'DST' }}</div>
                                    <div class="flight-val">{{ flights.in.terminal ? 'T'+flights.in.terminal : '-' }}</div>
                                </div>
                            </div>
                            <div style="height: 1px; background: #eee; margin: 10px 0;"></div>
                            <!-- å›ç¨‹ -->
                            <div class="flight-route" style="margin-bottom: 0;">
                                <div>
                                    <div class="flight-code">{{ flights.out.from || 'DST' }}</div>
                                    <div class="flight-val">{{ flights.out.time || '00:00' }}</div>
                                </div>
                                <div class="text-center">
                                    <div class="flight-label">{{ flights.out.date || 'Date' }}</div>
                                    <div class="flight-plane" style="transform: rotate(-90deg);">âœˆ</div>
                                    <div class="flight-label">{{ flights.out.no || 'Flight No.' }}</div>
                                </div>
                                <div class="text-center">
                                    <div class="flight-code">{{ flights.out.to || 'TPE' }}</div>
                                    <div class="flight-val">{{ flights.out.terminal ? 'T'+flights.out.terminal : '-' }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="day-slider" v-if="days.length > 0">
                    <div v-for="(d,i) in days" :key="i" class="day-btn" :class="{active: di===i}" @click="di=i">
                        <span style="font-size: 12px; opacity: 0.8;">{{ d.weekday }}</span>
                        <span style="font-size: 18px; font-weight: 700;">{{ getDayNumber(d.d) }}</span>
                    </div>
                    <div class="day-btn" @click="addDay" style="opacity: 0.5;">
                        <span style="font-size: 20px;">+</span>
                    </div>
                </div>

                <div v-if="days[di]" class="card" style="padding: 15px; display: flex; align-items: center; justify-content: space-between; border-left: 4px solid var(--accent);">
                    <div>
                        <div style="font-size: 12px; color: var(--text-light);">Day {{ di+1 }} Â· {{ days[di].d }}</div>
                        <input v-model="days[di].t" @change="saveData" class="input" style="border:none; padding: 0; font-size: 18px; font-weight: 700; margin: 5px 0 0 0; background: transparent; width: auto;" placeholder="è¼¸å…¥ç•¶æ—¥ä¸»é¡Œ...">
                    </div>
                    <button @click="deleteDay(di)" class="icon-btn" style="color: #E57373;">âœ–</button>
                </div>

                <div v-if="!days[di] || days[di].items.length===0" class="text-center" style="padding: 60px 0; color: #ccc;">
                    <div style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">âœï¸</div>
                    <p>ä»Šå¤©é‚„æ²’æœ‰å®‰æ’è¡Œç¨‹</p>
                </div>

                <div v-if="days[di]">
                    <div v-for="(item, i) in days[di].items" :key="i" class="item-card">
                        <div class="item-time-col">
                            <span class="item-time">{{ item.time }}</span>
                            <div style="width: 1px; flex: 1; background: #ccc; margin-top: 8px; border-right: 1px dashed #ccc;"></div>
                        </div>
                        <div class="item-main">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <div class="item-title">{{ item.name }}</div>
                                    <!-- å°èˆªåŠŸèƒ½ -->
                                    <div v-if="item.location" class="item-loc" @click="openGoogleMap(item.location)">
                                        <span style="color: var(--accent);">ğŸ“</span>
                                        {{ item.location }} 
                                        <span style="font-size: 10px; color: var(--primary); margin-left: 4px;">(å°èˆª)</span>
                                    </div>
                                    <div class="tag" :class="item.category">{{ item.category }}</div>
                                </div>
                                <div class="flex" style="gap: 2px;">
                                    <button @click="editItem(i)" class="icon-btn">âœ</button>
                                    <button @click="delItem(i)" class="icon-btn">âœ–</button>
                                </div>
                            </div>
                            <!-- å‚™è¨»èˆ‡é€£çµ -->
                            <div v-if="item.note" style="margin-top: 8px; font-size: 13px; color: #666; background: #F9F9F9; padding: 8px; border-radius: 8px; white-space: pre-wrap;">{{ item.note }}</div>
                            <div v-if="item.links && item.links.length > 0" style="margin-top: 6px;">
                                <a v-for="(link, lIdx) in item.links" :key="lIdx" :href="link.url" target="_blank" class="btn-link">
                                    ğŸ”— {{ link.name }}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" @click="showAdd=true">+ æ–°å¢è¡Œç¨‹</button>
            </div>

            <!-- 2. åœ°åœ– Tab -->
            <div v-show="tab==='map'" style="height: 100%;">
                <div class="map-container">
                    <div id="embedded-map"></div>
                    <div v-if="mapLoading" class="map-loading">
                        <div>ğŸ—ºï¸ åœ°åœ–è¼‰å…¥ä¸­...</div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <h3 style="font-size: 16px; margin-bottom: 10px; font-weight: 700; color: var(--primary);">ğŸ“ åœ°é»åˆ—è¡¨</h3>
                    <div style="display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto;">
                        <div v-for="(loc, idx) in allLocations" :key="idx" 
                             @click="flyToLocation(loc)"
                             style="background: white; padding: 12px; border-radius: 12px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                            <div>
                                <div style="font-weight: 700; font-size: 14px;">{{ loc.name }}</div>
                                <div style="font-size: 12px; color: #999;">{{ loc.day }}</div>
                            </div>
                            <div v-if="loc.lat" style="color: var(--primary); font-size: 12px;">å·²å®šä½</div>
                            <div v-else style="color: var(--accent); font-size: 12px;">æœå°‹ä¸­...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. åˆ†å¸³ Tab (å¤šå¹£åˆ¥å‡ç´šç‰ˆ) -->
            <div v-if="tab==='money'">
                <div class="card" style="border-left: 4px solid var(--primary);">
                    <h3 style="font-size: 16px; margin-bottom: 15px;">ğŸ‘¥ æˆå“¡è¨­å®š</h3>
                    <div class="flex" style="flex-wrap: wrap; margin-bottom: 15px;">
                        <div v-for="(m, idx) in members" :key="m" class="member-tag">
                            {{ m }} <span v-if="members.length > 1" @click="removeMember(idx)" style="cursor: pointer; color: #999; margin-left: 4px;">Ã—</span>
                        </div>
                    </div>
                    <div class="flex">
                        <input v-model="newMemberName" class="input" style="margin:0;" placeholder="è¼¸å…¥åå­—..." @keyup.enter="addMember">
                        <button @click="addMember" class="btn-add-small" style="width: auto;">æ–°å¢</button>
                    </div>
                </div>

                <!-- çµç®—å»ºè­° (å¤šå¹£åˆ¥) -->
                <div v-if="exps.length > 0" class="card" style="background: #FFF8F0; border-color: #F8E8D0;">
                    <h3 style="font-size: 16px; margin-bottom: 15px; color: #8B6B4E;">ğŸ§® çµç®—å»ºè­° (ä¾å¹£åˆ¥)</h3>
                    <div v-if="Object.keys(multiCurrencySettlement).length === 0" style="color: #999; font-size: 14px;">ç›®å‰å¸³ç›®å¹³è¡¡ã€‚</div>
                    
                    <div v-for="(plans, cur) in multiCurrencySettlement" :key="cur" style="margin-bottom: 15px;">
                        <div style="font-size: 12px; color: #8B6B4E; font-weight: bold; margin-bottom: 5px; background: rgba(139, 107, 78, 0.1); display: inline-block; padding: 2px 8px; border-radius: 4px;">
                            {{ cur }} çµç®—
                        </div>
                        <div v-for="(s, idx) in plans" :key="idx" style="padding: 5px 0; display: flex; align-items: center; justify-content: space-between; font-size: 14px;">
                            <div>
                                {{ s.from }} <span class="settle-arrow">â®•</span> {{ s.to }}
                            </div>
                            <div style="font-weight: 700;">{{ s.amount }} <span style="font-size:10px;">{{ cur }}</span></div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="font-size: 16px; font-weight: 700;">æ”¯å‡ºç´€éŒ„</h3>
                    <button class="btn-add-small" @click="openExpenseForm">+ è¨˜å¸³</button>
                </div>

                <div v-if="exps.length===0" class="text-center" style="padding: 40px 0; color: #ccc;">ç„¡æ”¯å‡ºç´€éŒ„</div>

                <div v-for="(e, i) in exps" :key="i" class="card" style="padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 15px; font-weight: 700;">{{ e.desc }}</div>
                        <div style="font-size: 12px; color: #999;">{{ e.by }} å…ˆä»˜ Â· åˆ†çµ¦ {{ e.split.join(', ') }}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 16px; font-weight: 700; color: var(--primary);">{{ e.amt }}</div>
                        <div style="font-size: 11px; color: #aaa;">{{ e.cur }}</div>
                    </div>
                    <button @click="delExp(i)" class="icon-btn" style="margin-left: 10px; color: #e57373;">Ã—</button>
                </div>
            </div>
            
            <!-- 4. æ¸…å–® Tab -->
            <div v-if="tab==='todo'">
                 <div class="card">
                    <h3 style="font-size: 16px; margin-bottom: 15px;">ğŸ“ å¾…è¾¦äº‹é …</h3>
                    <div class="flex" style="margin-bottom: 15px;">
                        <input v-model="newTodo" @keyup.enter="addTodo" class="input" style="margin:0;" placeholder="æ–°å¢å¾…è¾¦...">
                        <button @click="addTodo" class="btn-add-small">æ–°å¢</button>
                    </div>
                    <div v-for="(t, i) in todos" :key="i" style="padding: 10px 0; border-bottom: 1px dashed #eee; display: flex; align-items: center;">
                        <input type="checkbox" v-model="t.done" @change="saveData" style="margin-right: 10px; width: 18px; height: 18px; accent-color: var(--primary);">
                        <span :style="{textDecoration: t.done?'line-through':'none', color: t.done?'#ccc':'#444', flex:1}">{{ t.text }}</span>
                        <button @click="todos.splice(i,1);saveData()" class="icon-btn" style="width:24px; height:24px;">Ã—</button>
                    </div>
                </div>

                <div class="card" style="border-left: 4px solid var(--accent);">
                    <h3 style="font-size: 16px; margin-bottom: 15px;">ğŸ§³ è¡Œææ‰“åŒ…æ¸…å–®</h3>
                    <div class="flex" style="margin-bottom: 15px;">
                        <input v-model="newPackingItem" @keyup.enter="addPackingItem" class="input" style="margin:0;" placeholder="ä¾‹: è­·ç…§ã€è½‰æ¥é ­...">
                        <button @click="addPackingItem" class="btn-add-small" style="background: var(--accent);">æ–°å¢</button>
                    </div>
                    <div v-for="(t, i) in packingList" :key="i" style="padding: 10px 0; border-bottom: 1px dashed #eee; display: flex; align-items: center;">
                        <input type="checkbox" v-model="t.done" @change="saveData" style="margin-right: 10px; width: 18px; height: 18px; accent-color: var(--accent);">
                        <span :style="{textDecoration: t.done?'line-through':'none', color: t.done?'#ccc':'#444', flex:1}">{{ t.text }}</span>
                        <button @click="packingList.splice(i,1);saveData()" class="icon-btn" style="width:24px; height:24px;">Ã—</button>
                    </div>
                </div>

                <div class="card" style="margin-top: 30px; border-color: #eee;">
                    <h3 style="font-size: 16px; margin-bottom: 15px; color: var(--text-light);">ğŸ’¾ è³‡æ–™å‚™ä»½</h3>
                    <div class="flex">
                        <button @click="doExport" class="data-btn" style="background: #fcfcfc;">ğŸ“¤ åŒ¯å‡º</button>
                        <button @click="triggerImport" class="data-btn" style="background: #fcfcfc;">ğŸ“¥ åŒ¯å…¥</button>
                         <button @click="clearAllData" class="data-btn" style="color: #E57373; border-color: #ffdcdc; background: #fff5f5;">ğŸ—‘ï¸ æ¸…ç©º</button>
                    </div>
                    <input type="file" id="importFile" accept=".json" style="display: none;" @change="importData">
                </div>
            </div>

            <!-- 5. ç¿»è­¯ Tab -->
            <div v-if="tab==='translate'">
                <div class="text-center" style="margin-bottom: 20px;">
                    <h2 style="font-size: 20px; color: var(--primary); margin-bottom: 5px;">Google ç¿»è­¯æ·å¾‘</h2>
                    <p style="font-size: 13px; color: #999;">ç›®æ¨™èªè¨€ï¼š{{ getTargetLangName() }}</p>
                </div>
                <div style="margin-bottom: 20px;">
                     <div style="font-size: 12px; color: var(--primary); font-weight: bold; margin-bottom: 8px; margin-left: 5px;">âš¡ æ¥µé€Ÿæ¨¡å¼ (ç›´æ¥é–‹å•Ÿ App)</div>
                     <button @click="openNativeApp('translate')" class="translate-btn app-btn">
                        <div><span>ä½¿ç”¨æ‰‹æ©Ÿå…§å»º App</span><strong>é–‹å•Ÿ Google ç¿»è­¯</strong></div>
                        <div class="translate-icon">ğŸš€</div>
                    </button>
                </div>
                <div style="font-size: 12px; color: #999; font-weight: bold; margin-bottom: 8px; margin-left: 5px;">ğŸŒ ç¶²é ç‰ˆ (å…å®‰è£)</div>
                <a :href="'https://translate.google.com/?sl=' + getTranslateCode() + '&tl=zh-TW&op=images'" target="_blank" class="translate-btn">
                    <div><span>ç€è¦½å™¨é–‹å•Ÿ</span><strong>ç…§ç›¸ç¿»è­¯ (ç¶²é )</strong></div>
                    <div class="translate-icon" style="color: var(--accent);">ğŸ“·</div>
                </a>
                <a :href="'https://translate.google.com/?sl=zh-TW&tl=' + getTranslateCode() + '&op=translate'" target="_blank" class="translate-btn">
                    <div><span>ç€è¦½å™¨é–‹å•Ÿ</span><strong>ä¸­æ–‡ â®• {{ getTargetLangName() }}</strong></div>
                    <div class="translate-icon">ğŸ—£ï¸</div>
                </a>
            </div>
        </div>

        <!-- è¡Œç¨‹ Modal (æ–°å¢é€£çµ/å‚™è¨»åŠŸèƒ½) -->
        <div v-if="showAdd" class="modal" style="position:fixed; inset:0; z-index:1000; display:flex; align-items:flex-end;" @click.self="showAdd=false">
            <div class="modal-content" style="width:100%; padding: 24px; max-height: 85vh; overflow-y: auto;">
                <h3 style="margin-bottom: 20px;">{{ editIdx!==null?'ç·¨è¼¯è¡Œç¨‹':'æ–°å¢è¡Œç¨‹' }}</h3>
                <div class="mb-15">
                    <label style="font-size: 12px; color: #999;">æ™‚é–“</label>
                    <div class="flex">
                        <select v-model="form.h" class="input flex-1"><option v-for="h in 24" :value="pad(h-1)">{{ pad(h-1) }}</option></select>
                        <select v-model="form.m" class="input flex-1"><option v-for="m in ['00','15','30','45']" :value="m">{{ m }}</option></select>
                    </div>
                </div>
                <input v-model="form.name" class="input mb-15" placeholder="è¡Œç¨‹åç¨± (ä¾‹: æ·ºè‰å¯º)">
                <input v-model="form.location" class="input mb-15" placeholder="åœ°é» (å°èˆªç”¨ï¼Œä¾‹: Asakusa)">
                <div class="flex mb-15">
                    <button v-for="c in ['æ™¯é»','ç¾é£Ÿ','è³¼ç‰©','äº¤é€š']" :key="c" @click="form.category=c" 
                            class="btn" :style="{padding:'8px', fontSize:'13px', background: form.category===c?'var(--primary)':'#eee', color: form.category===c?'white':'#666'}">{{ c }}</button>
                </div>
                <!-- è©³ç´°å‚™è¨» -->
                <label style="font-size: 12px; color: #999;">è©³ç´°å‚™è¨»</label>
                <textarea v-model="form.note" class="input mb-15" placeholder="å¯è¼¸å…¥äº¤é€šæ–¹å¼ã€é¤å»³è¨‚ä½è™Ÿç¢¼ã€ç‡Ÿæ¥­æ™‚é–“..." style="height: 100px;"></textarea>
                
                <!-- é™„ä»¶é€£çµå€ -->
                <div class="mb-15" style="background: #f8f8f8; padding: 10px; border-radius: 12px;">
                    <label style="font-size: 12px; color: #999;">é™„ä»¶é€£çµ (é›»å­ç¥¨åˆ¸/PDFç¶²å€)</label>
                    <div v-for="(l, idx) in form.links" :key="idx" class="flex" style="margin-top: 5px;">
                        <input v-model="l.name" class="input" style="flex:1; margin:0; font-size:12px;" placeholder="åç¨± (ä¾‹: é–€ç¥¨)">
                        <input v-model="l.url" class="input" style="flex:2; margin:0; font-size:12px;" placeholder="https://...">
                        <button @click="form.links.splice(idx,1)" class="icon-btn" style="color: #e57373;">Ã—</button>
                    </div>
                    <button @click="form.links.push({name:'', url:''})" class="btn-link" style="margin-top: 8px; border:1px dashed #ccc; background:white;">+ æ–°å¢é€£çµ</button>
                </div>

                <button @click="saveAdd" class="btn btn-primary">å„²å­˜</button>
            </div>
        </div>
        
        <!-- èˆªç­ Modal -->
        <div v-if="showFlightEdit" class="modal" style="position:fixed; inset:0; z-index:1000; display:flex; align-items:flex-end;" @click.self="showFlightEdit=false">
            <div class="modal-content" style="width:100%; padding: 24px;">
                <h3 style="margin-bottom: 20px;">ç·¨è¼¯èˆªç­è³‡è¨Š</h3>
                <div style="font-size: 12px; font-weight: bold; color: var(--primary); margin-bottom: 10px;">å»ç¨‹ (Inbound)</div>
                <div class="flex mb-15"><input v-model="flights.in.date" class="input" placeholder="æ—¥æœŸ"><input v-model="flights.in.time" class="input" placeholder="æ™‚é–“"></div>
                <div class="flex mb-15"><input v-model="flights.in.from" class="input" placeholder="å‡ºç™¼ (TPE)"><input v-model="flights.in.to" class="input" placeholder="æŠµé” (NRT)"></div>
                <div class="flex mb-15"><input v-model="flights.in.no" class="input" placeholder="ç­æ¬¡ (JX800)"><input v-model="flights.in.terminal" class="input" placeholder="èˆªå»ˆ"></div>
                
                <div style="height:1px; background:#eee; margin: 20px 0;"></div>
                
                <div style="font-size: 12px; font-weight: bold; color: var(--primary); margin-bottom: 10px;">å›ç¨‹ (Outbound)</div>
                <div class="flex mb-15"><input v-model="flights.out.date" class="input" placeholder="æ—¥æœŸ"><input v-model="flights.out.time" class="input" placeholder="æ™‚é–“"></div>
                <div class="flex mb-15"><input v-model="flights.out.from" class="input" placeholder="å‡ºç™¼"><input v-model="flights.out.to" class="input" placeholder="æŠµé”"></div>
                <div class="flex mb-15"><input v-model="flights.out.no" class="input" placeholder="ç­æ¬¡"><input v-model="flights.out.terminal" class="input" placeholder="èˆªå»ˆ"></div>
                
                <button @click="saveFlight" class="btn btn-primary">å„²å­˜</button>
            </div>
        </div>

        <!-- æ”¯å‡º Modal -->
        <div v-if="showExpAdd" class="modal" style="position:fixed; inset:0; z-index:1000; display:flex; align-items:flex-end;" @click.self="showExpAdd=false">
            <div class="modal-content" style="width:100%; padding: 24px;">
                <h3 style="margin-bottom: 20px;">æ–°å¢æ”¯å‡º</h3>
                <input v-model="expForm.desc" class="input mb-15" placeholder="é …ç›® (ä¾‹: æ‹‰éºµ)">
                <div class="flex mb-15">
                    <input v-model.number="expForm.amt" type="number" class="input" placeholder="é‡‘é¡">
                    <select v-model="expForm.cur" class="input" style="margin-top:6px;">
                        <option :value="targetCurrency">{{ targetCurrency }}</option>
                        <option value="TWD">TWD</option>
                        <option value="USD">USD</option>
                    </select>
                </div>
                <div class="mb-15">
                    <div style="font-size:12px; color:#999; margin-bottom:5px;">èª°ä»˜çš„</div>
                    <div class="flex" style="flex-wrap:wrap; gap:8px;">
                        <button v-for="m in members" :key="m" @click="expForm.by=m" class="btn" style="width:auto;" :style="{padding:'8px 12px', background: expForm.by===m?'var(--primary)':'#eee', color: expForm.by===m?'white':'#666'}">{{ m }}</button>
                    </div>
                </div>
                 <div class="mb-15">
                    <div style="font-size:12px; color:#999; margin-bottom:5px;">åˆ†çµ¦èª°</div>
                    <div class="flex" style="flex-wrap: wrap;">
                         <label v-for="m in members" :key="'s'+m" style="padding: 8px 12px; background: #f5f5f5; border-radius: 20px; font-size: 13px; display:flex; align-items:center; gap:6px;">
                             <input type="checkbox" :value="m" v-model="expForm.split"> {{ m }}
                         </label>
                    </div>
                </div>
                <button @click="saveExp" class="btn btn-primary">å„²å­˜</button>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, nextTick } = Vue;

        createApp({
            setup() {
                const tab = ref('plan');
                const di = ref(0);
                const tripTitle = ref('');
                const tripDates = ref('');
                const startDate = ref('');
                const endDate = ref('');
                const targetCurrency = ref('JPY');
                const days = ref([]);
                const members = ref(['æˆ‘', 'æ—…ä¼´']);
                const exps = ref([]);
                const todos = ref([]);
                const packingList = ref([]);
                
                // èˆªç­è³‡è¨Š
                const showFlightCard = ref(false);
                const showFlightEdit = ref(false);
                const flights = ref({
                    in: { date:'', time:'', from:'', to:'', no:'', terminal:'' },
                    out: { date:'', time:'', from:'', to:'', no:'', terminal:'' }
                });

                const editingHeader = ref(false);
                const showAdd = ref(false);
                const showExpAdd = ref(false);
                const editIdx = ref(null);
                const newMemberName = ref('');
                
                const form = ref({ h:'09', m:'00', name:'', location:'', category:'æ™¯é»', note:'', links:[] });
                const expForm = ref({ desc:'', amt:'', cur:'JPY', by:'', split:[] });
                
                const weather = ref({ loaded: false, temp: 0, description: '', icon: '' });
                const map = ref(null);
                const mapLoading = ref(true);
                const markers = ref({});
                const locationCache = ref({});

                const pad = (n) => String(n).padStart(2, '0');
                const getDayNumber = (dStr) => dStr ? (dStr.split('/').length > 2 ? dStr.split('/')[2] : dStr) : '';

                // å°èˆªåŠŸèƒ½
                const openGoogleMap = (loc) => {
                    const q = `${tripTitle.value} ${loc}`;
                    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank');
                };

                // å¤šå¹£åˆ¥çµç®—é‚è¼¯
                const multiCurrencySettlement = computed(() => {
                    if (exps.value.length === 0) return {};
                    
                    // 1. æ•´ç†å‡ºæ‰€æœ‰å‡ºç¾éçš„å¹£åˆ¥
                    const currencies = [...new Set(exps.value.map(e => e.cur))];
                    const results = {};

                    currencies.forEach(cur => {
                        let balances = {};
                        members.value.forEach(m => balances[m] = 0);

                        // 2. åªè¨ˆç®—è©²å¹£åˆ¥çš„å¸³
                        const curExps = exps.value.filter(e => e.cur === cur);
                        if (curExps.length === 0) return;

                        curExps.forEach(e => {
                            if (!e.split || e.split.length === 0) return;
                            // ä»˜æ¬¾äºº +
                            if (balances[e.by] !== undefined) balances[e.by] += e.amt;
                            // åˆ†æ”¤äºº -
                            let splitAmt = e.amt / e.split.length;
                            e.split.forEach(person => {
                                if (balances[person] !== undefined) balances[person] -= splitAmt;
                            });
                        });

                        // 3. çµç®—è©²å¹£åˆ¥
                        let debtors = [];
                        let creditors = [];
                        for (let person in balances) {
                            let amt = Math.round(balances[person] * 100) / 100; // å°æ•¸é»è™•ç†
                            if (amt < -0.1) debtors.push({ name: person, amt: amt }); 
                            else if (amt > 0.1) creditors.push({ name: person, amt: amt }); 
                        }

                        debtors.sort((a, b) => a.amt - b.amt);
                        creditors.sort((a, b) => b.amt - a.amt);

                        let plan = [];
                        let i = 0; let j = 0;
                        while (i < debtors.length && j < creditors.length) {
                            let debt = Math.abs(debtors[i].amt);
                            let credit = creditors[j].amt;
                            let settleAmt = Math.min(debt, credit);
                            
                            if (settleAmt > 0) {
                                plan.push({
                                    from: debtors[i].name,
                                    to: creditors[j].name,
                                    amount: Math.round(settleAmt * 10) / 10
                                });
                            }

                            debtors[i].amt += settleAmt;
                            creditors[j].amt -= settleAmt;
                            if (Math.abs(debtors[i].amt) < 0.1) i++;
                            if (creditors[j].amt < 0.1) j++;
                        }
                        
                        if (plan.length > 0) results[cur] = plan;
                    });

                    return results;
                });

                const allLocations = computed(() => {
                    let locs = [];
                    days.value.forEach((d, dIdx) => {
                        d.items.forEach(item => {
                            if (item.location) {
                                locs.push({ name: item.name, location: item.location, day: `Day ${dIdx+1}`, lat: item.lat, lon: item.lon });
                            }
                        });
                    });
                    return locs;
                });

                const initData = () => {
                    const saved = localStorage.getItem('jp_trip_data');
                    if (saved) {
                        try {
                            const data = JSON.parse(saved);
                            tripTitle.value = data.title;
                            tripDates.value = data.dates;
                            days.value = data.days || [];
                            exps.value = data.exps || [];
                            targetCurrency.value = data.currency || 'JPY';
                            todos.value = data.todos || [];
                            packingList.value = data.packingList || [];
                            if (data.members) members.value = data.members;
                            if (data.flights) {
                                flights.value = data.flights;
                                showFlightCard.value = true;
                            }
                            locationCache.value = data.locCache || {};
                        } catch(e) {}
                    } else {
                        days.value = [{ d: '2025/01/01', weekday: 'WED', t: '', items: [] }];
                    }
                    if (tripTitle.value) fetchWeather(tripTitle.value);
                };

                const saveData = () => {
                    localStorage.setItem('jp_trip_data', JSON.stringify({
                        title: tripTitle.value, dates: tripDates.value, days: days.value, exps: exps.value,
                        currency: targetCurrency.value, todos: todos.value, packingList: packingList.value,
                        members: members.value, flights: flights.value, locCache: locationCache.value
                    }));
                };

                // Header & Currency
                const startEditHeader = () => editingHeader.value = true;
                const cancelHeaderEdit = () => editingHeader.value = false;
                const saveHeaderEdit = () => {
                    if(startDate.value && endDate.value) {
                        tripDates.value = `${startDate.value} ~ ${endDate.value}`;
                        generateDays();
                    }
                    editingHeader.value = false;
                    fetchWeather(tripTitle.value);
                    saveData();
                };
                const autoSetCurrency = () => {
                   const cityMap = { 'æ±äº¬': 'JPY', 'å¤§é˜ª': 'JPY', 'äº¬éƒ½': 'JPY', 'é¦–çˆ¾': 'KRW', 'æ›¼è°·': 'THB', 'å°åŒ—': 'TWD', 'å€«æ•¦': 'EUR', 'å·´é»': 'EUR', 'ç´ç´„': 'USD' };
                   if(cityMap[tripTitle.value]) targetCurrency.value = cityMap[tripTitle.value];
                };

                const generateDays = () => {
                    const s = new Date(startDate.value);
                    const e = new Date(endDate.value);
                    const diffDays = Math.ceil(Math.abs(e - s) / (86400000)) + 1; 
                    if (diffDays > 30) return;
                    const newDays = [];
                    const weekMap = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
                    for(let i=0; i<diffDays; i++) {
                        const d = new Date(s); d.setDate(d.getDate() + i);
                        const dateStr = `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}`;
                        const oldItem = days.value[i] || {};
                        newDays.push({ d: dateStr, weekday: weekMap[d.getDay()], t: oldItem.t || '', items: oldItem.items || [] });
                    }
                    days.value = newDays;
                };

                const addDay = () => { days.value.push({d: 'New Day', weekday: '-', t: '', items: []}); saveData(); };
                const deleteDay = (idx) => { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { days.value.splice(idx, 1); if(di.value >= days.value.length) di.value = Math.max(0, days.value.length - 1); saveData(); }};
                
                const editItem = (i) => {
                    editIdx.value = i;
                    const item = days.value[di.value].items[i];
                    const [h, m] = item.time.split(':');
                    // ç¢ºä¿ links å­˜åœ¨
                    const links = item.links ? [...item.links] : [];
                    form.value = { ...item, h, m, links };
                    showAdd.value = true;
                };
                const delItem = (i) => { days.value[di.value].items.splice(i, 1); saveData(); };
                const saveAdd = () => {
                    const newItem = {
                        time: `${form.value.h}:${form.value.m}`,
                        name: form.value.name,
                        location: form.value.location,
                        category: form.value.category,
                        note: form.value.note,
                        links: form.value.links.filter(l => l.url)
                    };
                    if (editIdx.value !== null) days.value[di.value].items[editIdx.value] = newItem;
                    else { days.value[di.value].items.push(newItem); days.value[di.value].items.sort((a,b) => a.time.localeCompare(b.time)); }
                    showAdd.value = false; editIdx.value = null;
                    form.value = { h:'09', m:'00', name:'', location:'', category:'æ™¯é»', note:'', links:[] };
                    saveData();
                };

                const saveFlight = () => { showFlightEdit.value = false; saveData(); };

                const addMember = () => { if (newMemberName.value && !members.value.includes(newMemberName.value)) { members.value.push(newMemberName.value); newMemberName.value = ''; saveData(); }};
                const removeMember = (idx) => { if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { members.value.splice(idx, 1); saveData(); }};

                const openExpenseForm = () => { expForm.value = { desc:'', amt:'', cur: targetCurrency.value, by: members.value[0], split: [...members.value] }; showExpAdd.value = true; };
                const saveExp = () => { if(!expForm.value.desc || !expForm.value.amt) return; exps.value.push({ ...expForm.value }); showExpAdd.value = false; saveData(); };
                const delExp = (i) => { exps.value.splice(i, 1); saveData(); };

                const newTodo = ref('');
                const addTodo = () => { if(newTodo.value) { todos.value.push({text: newTodo.value, done: false}); newTodo.value = ''; saveData(); }};
                const newPackingItem = ref('');
                const addPackingItem = () => { if(newPackingItem.value) { packingList.value.push({text: newPackingItem.value, done: false}); newPackingItem.value = ''; saveData(); }};

                const fetchWeather = async (city) => {
                    if (!city) return;
                    const map = { 'æ±äº¬': 'Tokyo', 'å¤§é˜ª': 'Osaka', 'å°åŒ—': 'Taipei', 'é¦–çˆ¾': 'Seoul' };
                    try {
                        const res = await fetch(`https://wttr.in/${map[city]||city}?format=j1`);
                        const data = await res.json();
                        weather.value = { loaded: true, temp: data.current_condition[0].temp_C, description: data.current_condition[0].weatherDesc[0].value, icon: 'ğŸŒ¤ï¸' };
                    } catch(e) {}
                };

                const getTranslateCode = () => ({ 'JPY': 'ja', 'USD': 'en', 'EUR': 'en', 'KRW': 'ko', 'THB': 'th', 'TWD': 'en' }[targetCurrency.value] || 'en');
                const getTargetLangName = () => ({ 'JPY': 'æ—¥æ–‡', 'USD': 'è‹±æ–‡', 'EUR': 'æ­èª', 'KRW': 'éŸ“æ–‡', 'THB': 'æ³°æ–‡', 'TWD': 'å¤–èª' }[targetCurrency.value] || 'å¤–èª');
                const openNativeApp = () => { window.location.href = 'googletranslate://'; };

                const doExport = () => {
                    const blob = new Blob([JSON.stringify({ title: tripTitle.value, dates: tripDates.value, days: days.value, exps: exps.value, currency: targetCurrency.value, todos: todos.value, packingList: packingList.value, members: members.value, flights: flights.value, locCache: locationCache.value }, null, 2)], { type: 'application/json' });
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (tripTitle.value || 'è¡Œç¨‹') + '.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
                };
                const triggerImport = () => document.getElementById('importFile').click();
                const importData = (event) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if(confirm('åŒ¯å…¥å°‡è¦†è“‹ç¾æœ‰è¡Œç¨‹ï¼Œç¢ºå®šå—ï¼Ÿ')) {
                                Object.assign(days, {value: data.days||[]});
                                tripTitle.value = data.title; tripDates.value = data.dates; exps.value = data.exps||[]; todos.value = data.todos||[]; packingList.value = data.packingList||[]; members.value = data.members||['æˆ‘']; flights.value = data.flights||flights.value; locationCache.value = data.locCache||{};
                                saveData(); alert('åŒ¯å…¥æˆåŠŸ');
                            }
                        } catch(err) { alert('æ ¼å¼éŒ¯èª¤'); }
                    };
                    reader.readAsText(event.target.files[0]);
                    event.target.value = '';
                };
                const clearAllData = () => { if(confirm('æ¸…ç©ºè³‡æ–™ï¼Ÿ')) { localStorage.removeItem('jp_trip_data'); location.reload(); }};

                const initMap = () => {
                    if (map.value) return;
                    map.value = L.map('embedded-map').setView([35.6895, 139.6917], 11);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; OSM & Carto', subdomains: 'abcd', maxZoom: 20 }).addTo(map.value);
                    mapLoading.value = false;
                    updateMapMarkers();
                };
                const geocodeLocation = async (query) => {
                    if (locationCache.value[query]) return locationCache.value[query];
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
                        const data = await res.json();
                        if (data && data.length > 0) {
                            const result = { lat: data[0].lat, lon: data[0].lon };
                            locationCache.value[query] = result; saveData(); return result;
                        }
                    } catch (e) {}
                    return null;
                };
                const updateMapMarkers = async () => {
                    if (!map.value) return;
                    Object.values(markers.value).forEach(m => map.value.removeLayer(m));
                    markers.value = {};
                    const bounds = [];
                    for (const d of days.value) {
                        for (const item of d.items) {
                            if (item.location) {
                                let coords = item.lat && item.lon ? { lat: item.lat, lon: item.lon } : await geocodeLocation(`${tripTitle.value} ${item.location}`);
                                if (coords) {
                                    item.lat = coords.lat; item.lon = coords.lon;
                                    const marker = L.marker([coords.lat, coords.lon]).addTo(map.value).bindPopup(`<b>${item.name}</b><br>${item.time}`);
                                    markers.value[`${coords.lat},${coords.lon}`] = marker;
                                    bounds.push([coords.lat, coords.lon]);
                                }
                            }
                        }
                    }
                    if (bounds.length > 0) map.value.fitBounds(bounds, { padding: [50, 50] });
                    saveData();
                };
                const switchTab = (t) => { tab.value = t; if (t === 'map') { nextTick(() => { initMap(); setTimeout(() => { map.value.invalidateSize(); }, 200); updateMapMarkers(); }); }};
                const flyToLocation = (loc) => { if (loc.lat && loc.lon && map.value) { map.value.flyTo([loc.lat, loc.lon], 16); const key = `${loc.lat},${loc.lon}`; if (markers.value[key]) markers.value[key].openPopup(); } else { alert('æœå°‹ä¸­...'); updateMapMarkers(); }};

                initData();

                return {
                    tab, di, days, tripTitle, tripDates, weather, editingHeader, startDate, endDate, startEditHeader, cancelHeaderEdit, saveHeaderEdit, autoSetCurrency,
                    getDayNumber, addDay, deleteDay, showAdd, form, editIdx, editItem, delItem, saveAdd, openGoogleMap,
                    targetCurrency, exps, showExpAdd, expForm, members, openExpenseForm, saveExp, delExp, multiCurrencySettlement,
                    todos, newTodo, addTodo, packingList, newPackingItem, addPackingItem, saveData, switchTab, mapLoading, allLocations, flyToLocation, pad,
                    getTranslateCode, getTargetLangName, doExport, triggerImport, importData, clearAllData, openNativeApp,
                    flights, showFlightCard, showFlightEdit, saveFlight, addMember, removeMember, newMemberName
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
